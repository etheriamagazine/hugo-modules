{{ define "main" }}

  {{/* Store ads and ad index */}}
  {{ .Page.Store.Set "ads" (partial "easyads/get.html" "home") }}
  {{ .Page.Store.Set "nextAd" 0 }}

  {{/* Get latest and pinned posts as per configuration in data/home.yaml  */}}
  {{ $latest := partial "home/latest-posts" }}
  {{ $pinned := partial "home/pinned-posts" }}

  {{/* Compute featured posts  */}}
  {{ $featuredCount := site.Data.home.featuredPostsCount }}

  {{ $featured := (first 1 $latest) }}
  {{ $featured  = union $featured $pinned }}
  {{ $featured  = union $featured (after 1 $latest) }}
  {{ $featured  = first $featuredCount $featured }}

  {{/* 1. Featured posts */}}
  <section>
    {{ partial "hero-and-posts" (dict "posts" $featured "cols" 3) }}
  </section>

  {{/* 2. First Ad */}}

  {{/* 3. Subscription */}}
  <div class="max-w-(--my-max-w) m-auto mt-8 grid px-4 md:grid-cols-2">
    <aside>
      {{ partial "subscribe/form.html" }}
    </aside>

    {{ partial "home/render-next-ad" . }}

  </div>

  {{/* 3: Next Ad */}}
  {{ partial "home/render-next-ad" . }}

  {{/* 4. Render home category previews */}}
  {{ $categories := slice }}
  {{ $nextAdIndex := 2 }}

  {{ with site.Data.home.categoriesToDisplay }}
    {{ $categories = . }}
  {{ else }}
    {{ range $term, $v := .Site.Taxonomies.categories }}
      {{ $categories = $categories | append $term }}
    {{ end }}
  {{ end }}

  {{ range $categories }}
    {{ $wp := index site.Taxonomies.categories . }}

    {{/* Check the weighted pages for term has pages to show
      See https://gohugo.io/methods/taxonomy/get/#get-the-weighted-pages
    */}}
    {{ with and (gt $wp.Count 0) $wp }}
      <section class="mt-20">
        {{ with .Page }}
          <header class="mx-4 my-12 md:mx-36">
            <h2
              class="text-primary font-stretch-85% my-4 text-3xl uppercase md:text-4xl">
              {{ .Title }}
            </h2>
            {{ .Description }}
          </header>
        {{ end }}

        {{ $count := site.Data.home.postsCountPerCategory | default 7 }}
        {{/* Select posts not already shown featured posts */}}
        {{ $categoryPreview := first $count ( .Pages.ByLastmod.Reverse  | complement $featured ) }}

        {{ partial "hero-and-posts" (dict "posts" $categoryPreview "cols" 3) }}

      </section>
      {{ partial "home/render-next-ad" $ }}
    {{ end }}
  {{ end }}

{{ end }}

{{ define "_partials/home/render-next-ad.html" }}
  {{ $ads := .Page.Store.Get "ads" }}
  {{ $nextAd := .Page.Store.Get "nextAd" }}

  {{ with index $ads $nextAd }}
    <aside class="my-20 flex flex-col items-center justify-center gap-10">
      {{ .Render "embed" }}
    </aside>
  {{ end }}

  {{ .Page.Store.Add "nextAd" 1 }}
{{ end }}
