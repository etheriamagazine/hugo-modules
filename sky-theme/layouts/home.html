{{ define "main" }}

  {{/* store ads and ad index */}}

  {{ .Page.Store.Set "ads" (partial "easyads/get.html" "home") }}
  {{ .Page.Store.Set "nextAd" 0 }}

  {{ $latestPosts := where site.RegularPages.ByLastmod.Reverse "Type" "posts" }}

  {{/* 1. Featured Stories */}}
  {{ with site.Params.skytheme.home.featured }}
    {{ $latestPosts = where $latestPosts "Params.categories" "intersect" . }}
  {{ end }}

  {{ $featured := first 5 $latestPosts }}

  {{ $ads := partial "easyads/get.html" "home" }}

  {{/* 1. Hero */}}
  <section>
    {{ partial "hero-and-posts" (dict "posts" $featured "cols" 4) }}
  </section>

  {{/* 2. First Ad */}}
  {{ partial "home/render-next-ad" . }}

  {{/* 3. Subscription */}}
  <aside>
    {{ partial "subscribe/form.html" }}
  </aside>

  {{/* 3: Next Ad */}}
  {{ partial "home/render-next-ad" . }}

  {{/* 4. Render home category previews */}}
  {{ $categories := slice }}
  {{ $nextAdIndex := 2 }}

  {{ with site.Params.skytheme.home.categories }}
    {{ $categories = . }}
  {{ else }}
    {{ range $term, $v := .Site.Taxonomies.categories }}
      {{ $categories = $categories | append $term }}
    {{ end }}
  {{ end }}

  {{ range $categories }}
    {{ $wp := index site.Taxonomies.categories . }}

    {{/* Check the weighted pages for term has pages to show
      See https://gohugo.io/methods/taxonomy/get/#get-the-weighted-pages
    */}}
    {{ with and (gt $wp.Count 0) $wp }}
      <section class="mt-20">
        {{ with .Page }}
          <header class="mx-4 my-12 md:mx-36">
            <h2
              class="text-primary font-stretch-85% my-4 text-3xl uppercase md:text-4xl">
              {{ .Title }}
            </h2>
            {{ .Description }}
          </header>
        {{ end }}

        {{/* Select posts not already shown featured posts */}}
        {{ $categoryPreview := first 7 ( .Pages.ByLastmod.Reverse  | complement $featured ) }}

        {{ partial "hero-and-posts" (dict "posts" $categoryPreview "cols" 3) }}

      </section>
      {{ partial "home/render-next-ad" $ }}
    {{ end }}
  {{ end }}

{{ end }}

{{ define "_partials/home/render-next-ad.html" }}
  {{ $ads := .Page.Store.Get "ads" }}
  {{ $nextAd := .Page.Store.Get "nextAd" }}

  {{ with index $ads $nextAd }}
    <aside class="my-20 flex flex-col items-center justify-center gap-10">
      {{ .Render "embed" }}
    </aside>
  {{ end }}

  {{ .Page.Store.Add "nextAd" 1 }}
{{ end }}
