{{ with and hugo.IsProduction site.Params.plausible }}
  {{ if or .enable (not (isset . "enable")) }}
    {{ $siteScriptId := or (.siteScriptId | strings.TrimSuffix ".js") (errorf "module plausible: no tracking script specified in config") }}

    {{ $src := printf "https://plausible.io/js/%s.js" $siteScriptId  }}
    {{ $opts := dict }}

    {{ with (and .proxy (.proxyPath | strings.TrimRight "/")) }}
      {{ $src = printf "%s/js/%s.js" . $siteScriptId }}
      {{ $opts = merge $opts (dict "endpoint" (printf "%s/api/event" .)) }}
    {{ end }}

    {{ with .captureOnLocalhost }}
      {{ $opts = merge $opts (dict "captureOnLocalhost" true)}}
    {{ end }}

    <!-- Privacy-friendly analytics by Plausible -->
    <script async src="{{ $src }}"></script>
    <script>
      window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
      plausible.init({{ $opts | jsonify | safeJS }})
    </script>

  {{ end }}
{{ end }}
